<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Judul Halaman Diperbarui -->
    <title>Daftar Nilai Informatika Kelas 9 Tahun 2025</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Warna latar belakang terang */
        }
        /* Styling untuk loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981; /* Warna hijau emerald */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .footer {
            background-color: #1f2937; /* bg-gray-800 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <main class="flex-grow p-4 sm:p-8">
        <div class="max-w-7xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">

            <!-- Message Box untuk notifikasi -->
            <div id="messageBox" class="hidden fixed top-4 right-4 z-50 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-opacity duration-300" role="alert">
                <p id="messageText"></p>
            </div>

            <!-- Header dengan Thumbnail dan Nama -->
            <header class="flex flex-col items-center justify-center mb-8">
                
                <!-- SoundCloud Player (Otomatis Putar) -->
                <!-- Catatan: Autoplay pada iframe mungkin diblokir oleh kebijakan browser modern, namun kode sudah disetel ke auto_play=true -->
                <div class="mb-6 w-full max-w-lg mx-auto rounded-xl overflow-hidden shadow-lg">
                    <iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/soundcloud%253Atracks%253A2213534183&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
                    <div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;" class="p-2 bg-gray-900 text-center">
                        <a href="https://soundcloud.com/reza-07-849961971" title="Reza 07" target="_blank" style="color: #cccccc; text-decoration: none;">Reza 07</a> Â· <a href="https://soundcloud.com/reza-07-849961971/fahmil-arabi-syair-rayu-kumbang" title="wwd.mFahmil Arabi - Syair Rayu Kumbang" target="_blank" style="color: #cccccc; text-decoration: none;">wwd.mFahmil Arabi - Syair Rayu Kumbang</a>
                    </div>
                </div>

                <!-- Teks Bergerak (Marquee) Diperbarui -->
                <div class="w-full text-center mb-4 p-2 bg-yellow-100 rounded-lg shadow-inner border-y-2 border-yellow-300">
                    <marquee class="text-lg font-bold text-yellow-800" behavior="scroll" direction="left" scrollamount="6">
                        Selamat Datang Siswa- Siswi Mapel Informatika SMP Negeri 11 Lhokseumawe
                    </marquee>
                </div>

                <!-- Foto Profil Reza, ST dengan URL Baru -->
                <img src="https://iili.io/fHYokxV.jpg" 
                     alt="Foto Profil Reza, ST" 
                     class="w-20 h-20 rounded-full border-4 border-emerald-600 shadow-lg mb-2 object-cover">
                
                <!-- Nama di bawah Thumbnail -->
                <p class="text-lg font-bold text-gray-800 mb-4">Reza, ST.</p>

                <!-- Judul Diperbarui -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center">
                    Daftar Nilai Informatika Kelas 9 Tahun 2025
                </h1>
            </header>
            
            <!-- Kontainer Loading dan Data -->
            <div id="loading" class="flex justify-center items-center py-12">
                <div class="spinner"></div>
                <p class="ml-4 text-lg text-gray-600">Memuat data dari Google Sheets...</p>
            </div>

            <div id="data-container" class="hidden">
                
                <!-- New Buttons Section: Preview dan Download -->
                <div class="flex justify-center sm:justify-end gap-4 mb-6">
                    <button id="previewBtn" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 ease-in-out">
                        Preview (Muat Ulang Data)
                    </button>
                    <button id="downloadBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out">
                        Download (Unduh CSV)
                    </button>
                </div>

                <!-- Kontrol Pencarian dan Paginasi Atas -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                    
                    <!-- Kontrol Pencarian -->
                    <div class="w-full sm:w-1/3">
                        <input type="text" id="searchInput" placeholder="Cari berdasarkan NIS, Nama, Kelas, atau lainnya..." class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 ease-in-out">
                    </div>

                    <!-- Kontrol Rows per Page (Ditempatkan di kanan) -->
                    <div class="flex items-center space-x-2">
                        <label for="rowsPerPage" class="text-sm font-medium text-gray-700">Tampilkan:</label>
                        <select id="rowsPerPage" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 ease-in-out">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="99999">Semua</option>
                        </select>
                        <span class="text-sm text-gray-500">baris</span>
                    </div>
                </div>

                <!-- Area Tabel - Responsif -->
                <div class="overflow-x-auto shadow-xl rounded-xl border border-gray-200">
                    <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-emerald-600 text-white sticky top-0">
                            <tr id="table-headers">
                                <!-- Headers akan dimasukkan di sini oleh JS -->
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-100">
                            <!-- Data akan dimasukkan di sini oleh JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Kontrol Paginasi Bawah dan Informasi -->
                <div id="pagination-controls" class="flex flex-col sm:flex-row justify-between items-center mt-6 space-y-4 sm:space-y-0">
                    
                    <!-- Informasi Baris -->
                    <div id="row-info" class="text-sm text-gray-700 font-medium">
                        <!-- 'Menampilkan 1 hingga 10 dari 50 entri' -->
                    </div>
                    
                    <!-- Tombol Paginasi -->
                    <div id="page-buttons" class="flex space-x-2">
                        <button id="prev-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                            &larr; Sebelumnya
                        </button>
                        <span id="page-number" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg">1</span>
                        <button id="next-page" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                            Berikutnya &rarr;
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Pesan Error -->
            <div id="error-message" class="hidden text-center py-12 text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-lg font-semibold">Gagal memuat data.</p>
                <p class="text-sm">Pastikan URL Google Sheets sudah benar dan telah dipublikasikan sebagai CSV.</p>
            </div>

        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer mt-8 py-4 text-center">
        <!-- Baris Copyright -->
        <div class="text-white text-xs">
            @2025 Informatika by Reza ST
        </div>
    </footer>


    <script>
        // Data Global dan State Paginasi
        let allData = [];
        let filteredData = []; // Digunakan untuk menyimpan hasil pencarian
        let tableHeaders = [];
        let currentPage = 1;
        let rowsPerPage = 10;
        let searchTerm = ''; // State untuk menyimpan kata kunci pencarian
        
        // URL Read-Only CSV yang telah diperbaiki
        const CSV_READ_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTKazHAo1y678Zap12C5RgmqTsTGWou9X3eGnT6yH_zjBWLCh6ArnUp302h9PkEfdn_351biwZzmQ2z/pub?output=csv&gid=0';

        // Mendapatkan elemen DOM
        const loadingEl = document.getElementById('loading');
        const dataContainerEl = document.getElementById('data-container');
        const errorEl = document.getElementById('error-message');
        const headersEl = document.getElementById('table-headers');
        const bodyEl = document.getElementById('table-body');
        const rowsPerPageEl = document.getElementById('rowsPerPage');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageNumberEl = document.getElementById('page-number');
        const rowInfoEl = document.getElementById('row-info');
        const searchInputEl = document.getElementById('searchInput'); // Elemen input pencarian
        const previewBtn = document.getElementById('previewBtn'); // Tombol Preview
        const downloadBtn = document.getElementById('downloadBtn'); // Tombol Download
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        /**
         * Menampilkan pesan notifikasi sementara
         */
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Mengubah teks CSV menjadi array of objects.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return { headers: [], rows: [] };

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));

                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Pastikan baris memiliki data yang valid (setidaknya satu nilai bukan string kosong)
                if (Object.values(row).some(v => v !== '')) {
                    rows.push(row);
                }
            }
            return { headers, rows };
        }

        /**
         * Mengambil data dari Google Sheets URL
         */
        async function fetchData() {
            loadingEl.classList.remove('hidden');
            dataContainerEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            try {
                const response = await fetch(CSV_READ_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);

                tableHeaders = parsedData.headers;
                allData = parsedData.rows;

                if (allData.length === 0) {
                    throw new Error("Data kosong atau gagal diurai.");
                }

                // Inisialisasi tampilan
                renderHeaders();
                applySearchAndRender(); 
                
                loadingEl.classList.add('hidden');
                dataContainerEl.classList.remove('hidden');
                showMessage('Data berhasil dimuat ulang.', false);

            } catch (error) {
                console.error("Gagal memuat atau mengurai data:", error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                showMessage('Gagal memuat data. Cek koneksi atau URL Sheets.', true);
            }
        }

        /**
         * Konversi Array of Objects menjadi string CSV
         */
        function convertToCSV(data, headers) {
            if (data.length === 0 || headers.length === 0) return '';
            
            // Fungsi untuk mengamankan nilai (handle koma dan kutipan)
            const escapeValue = (value) => {
                if (value === null || value === undefined) return '';
                let str = String(value);
                // Mengganti semua kutipan ganda dengan dua kutipan ganda
                str = str.replace(/"/g, '""');
                // Jika string mengandung koma, baris baru, atau kutipan ganda, bungkus dengan kutipan ganda
                if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                    return `"${str}"`;
                }
                return str;
            };

            // 1. Header Row
            const csvHeaders = headers.map(escapeValue).join(',');
            
            // 2. Data Rows
            const csvRows = data.map(row => {
                // Map header ke nilai yang sesuai di baris
                return headers.map(header => escapeValue(row[header])).join(',');
            });

            return [csvHeaders, ...csvRows].join('\n');
        }

        /**
         * Trigger download CSV
         */
        function downloadCSV() {
            if (filteredData.length === 0) {
                showMessage('Tidak ada data yang cocok dengan filter saat ini untuk diunduh.', true); 
                return;
            }

            const csvString = convertToCSV(filteredData, tableHeaders);
            
            // Membuat Blob
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Menentukan nama file berdasarkan judul baru
            const fileName = 'Daftar_Nilai_Informatika_Kelas_9_2025.csv';

            if (navigator.msSaveBlob) { // Untuk IE 10+
                navigator.msSaveBlob(blob, fileName);
                showMessage('Data berhasil diunduh.', false);
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('Data berhasil diunduh.', false);
            }
        }
        
        /**
         * Menerapkan filter pencarian pada semua data
         */
        function applySearchAndRender() {
            currentPage = 1; 
            const term = searchTerm.toLowerCase();

            if (!term) {
                filteredData = allData;
            } else {
                filteredData = allData.filter(row => {
                    return Object.values(row).some(value => {
                        return String(value).toLowerCase().includes(term);
                    });
                });
            }
            renderTable();
        }


        /**
         * Merender header tabel
         */
        function renderHeaders() {
            headersEl.innerHTML = ''; 
            tableHeaders.forEach(headerText => {
                const th = document.createElement('th');
                // Kelas border-r untuk pemisah kolom
                th.className = 'px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider border-r border-emerald-500 last:border-r-0';
                th.textContent = headerText;
                headersEl.appendChild(th);
            });
            
            // Kolom Aksi (Cetak) telah dihapus
        }

        /**
         * Merender tubuh tabel berdasarkan data yang sudah difilter/dicari
         */
        function renderTable() {
            const dataToRender = filteredData; 
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = dataToRender.slice(start, end);

            bodyEl.innerHTML = ''; 

            // totalCols sekarang hanya = jumlah header data (tidak +1 untuk Aksi)
            const totalCols = tableHeaders.length; 

            if (paginatedData.length === 0) {
                bodyEl.innerHTML = `<tr><td colspan="${totalCols}" class="px-6 py-4 text-center text-gray-500">Tidak ada data yang cocok dengan pencarian Anda.</td></tr>`;
                renderPaginationInfo(0, 0, dataToRender.length);
                return;
            }

            paginatedData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = rowIndex % 2 === 0 ? 'bg-gray-50 hover:bg-gray-100 transition duration-150' : 'bg-white hover:bg-gray-100 transition duration-150';
                
                tableHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    td.textContent = row[header];
                    tr.appendChild(td);
                });

                bodyEl.appendChild(tr);
            });

            updatePaginationControls(dataToRender.length); 
            renderPaginationInfo(start + 1, start + paginatedData.length, dataToRender.length);
        }

        /**
         * Memperbarui tombol paginasi berdasarkan jumlah data yang difilter
         */
        function updatePaginationControls(totalRows) {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            pageNumberEl.textContent = `${currentPage} dari ${totalPages}`;

            if (rowsPerPage >= totalRows && totalRows > 0) {
                prevPageBtn.classList.add('hidden');
                nextPageBtn.classList.add('hidden');
                pageNumberEl.classList.add('hidden');
            } else if (totalRows === 0) {
                 prevPageBtn.classList.add('hidden');
                nextPageBtn.classList.add('hidden');
                pageNumberEl.classList.add('hidden');
            } else {
                prevPageBtn.classList.remove('hidden');
                nextPageBtn.classList.remove('hidden');
                pageNumberEl.classList.remove('hidden');
            }
        }
        
        /**
         * Merender informasi baris yang ditampilkan
         */
        function renderPaginationInfo(start, end, total) {
            if (rowsPerPage >= total || total === 0) {
                 rowInfoEl.textContent = `Menampilkan ${total} entri`;
            } else {
                rowInfoEl.textContent = `Menampilkan ${start} hingga ${end} dari ${total} entri`;
            }
        }

        /**
         * Handler untuk mengubah halaman
         */
        function changePage(delta) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        /**
         * Handler untuk mengubah jumlah baris per halaman
         */
        function changeRowsPerPage(event) {
            rowsPerPage = parseInt(event.target.value);
            currentPage = 1; 
            renderTable();
        }
        
        /**
         * Handler untuk input pencarian
         */
        function handleSearchInput(event) {
            searchTerm = event.target.value.trim();
            applySearchAndRender();
        }

        // === EVENT LISTENERS ===
        
        rowsPerPageEl.addEventListener('change', changeRowsPerPage);
        prevPageBtn.addEventListener('click', () => changePage(-1));
        nextPageBtn.addEventListener('click', () => changePage(1));
        searchInputEl.addEventListener('keyup', handleSearchInput); 
        searchInputEl.addEventListener('change', handleSearchInput); 
        
        // Listener untuk tombol menu
        previewBtn.addEventListener('click', fetchData);
        downloadBtn.addEventListener('click', downloadCSV);


        // Memuat data saat halaman dimuat
        window.onload = fetchData;
    </script>

</body>
</html>
